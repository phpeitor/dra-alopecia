<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Citas | Alopecia Corp.</title>
  <link rel="icon" type="image/svg+xml" href="./img/favicon-2.svg" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
  <link rel="stylesheet" href="./css/app.css">
  <link rel="stylesheet" type="text/css" href="./css/view-patients.css">
  <link rel="stylesheet" href=./css/search_health_workers.css>
  <link rel="stylesheet" type="text/css" href="./css/health_workers_cards.css">
  <link rel="stylesheet" href="./css/navbar.css">
  <link rel="stylesheet" href="./css/footer.css">
</head>
<body>
  <section class="pt-4 mb-4 m-auto medium-container">
      <div id="health-workers-search" class="search-health-worker">
          <div class="px-2 py-4 pb-4 search-health-worker__container">
              <h5 style="color:#405f8d;margin: 0 0 12px;">Listado de Citas</h5>

              <div class="toolbar">
                <div class="mb-md-2 pe-md-2">
                  <label>Desde</label>
                  <input class="w-100 ps-2" type="date" id="from" />
                </div>
                <div class="mb-md-2 pe-md-2">
                  <label>Hasta</label>
                  <input class="w-100 ps-2" type="date" id="to" />
                </div>
                <div class="mb-md-2 pe-md-2">
                  <label>Sede</label>
                  <select class="w-100 ps-2" id="sede">
                    <option value="">Todas</option>
                    <option value="Lima">Lima</option>
                    <option value="Arequipa">Arequipa</option>
                  </select>
                </div>
                <div class="mb-md-2 pe-md-2">
                  <label>Tipo</label>
                  <select class="w-100 ps-2" id="tipo">
                    <option value="">Todos</option>
                    <option value="presencial">Presencial</option>
                    <option value="virtual">Virtual</option>
                  </select>
                </div>
                <div class="mb-md-2 pe-md-2">
                  <label>Status</label>
                  <select class="w-100 ps-2" id="status">
                    <option value="">Todos</option>
                    <option value="PENDIENTE">PENDIENTE</option>
                    <option value="CONFIRMADO">CONFIRMADO</option>
                    <option value="CANCELADO">CANCELADO</option>
                    <option value="COMPLETADO">COMPLETADO</option>
                  </select>
                </div>
                <div class="mb-md-2 pe-md-2">
                  <label>Profesional</label>
                  <input class="form-control" type="text" id="profesional" placeholder="Ej. Dra. Belén" />
                </div>
                <div style="grid-column: span 12;" class="actions">
                  <button class="btn" id="btn-load">Cargar</button>
                  <button class="btn secondary" id="btn-export">Exportar CSV</button>
                </div>
              </div>

              <div id="grid"></div>
          </div>
      </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
  <script>
    const container = document.getElementById('grid');

    const hot = new Handsontable(container, {
      data: [],
      rowHeaders: true,
      colHeaders: [
        'ID','Nombre','Email','DNI','Teléfono','Nacimiento','Dirección','Mensaje',
        'Fecha Cita','Precio','Fecha Registro','Profesional','Status','Sede','Tipo'
      ],
      columns: [
        { data: 'id', readOnly: true, width: 60 },
        { data: 'nombre', width: 160 },
        { data: 'email', width: 220 },
        { data: 'dni', width: 100 },
        { data: 'telefono', width: 120 },
        { data: 'fecha_nacimiento', width: 120 },
        { data: 'direccion', width: 200 },
        { data: 'mensaje', width: 260 },
        { data: 'fecha_cita', width: 150 },
        { data: 'precio', width: 80, type: 'numeric', numericFormat: { pattern: '0.00' } },
        { data: 'fecha_registro', width: 150 },
        { data: 'profesional', width: 180 },
        { data: 'status', width: 120, renderer: statusRenderer },
        { data: 'sede', width: 110 },
        { data: 'tipo', width: 110 }
      ],
      licenseKey: 'non-commercial-and-evaluation',
      stretchH: 'all',
      height: 'auto',
      manualColumnResize: true,
      filters: true,
      dropdownMenu: true,
      contextMenu: ['copy','copy_with_column_headers','-----------','column_left','column_right','remove_row'],
    });

    function statusRenderer(instance, td, row, col, prop, value, cellProperties) {
      const v = (value || '').toString().toUpperCase();
      td.innerHTML = `<span class="status-pill st-${v}">${v || ''}</span>`;
      td.style.textAlign = 'center';
      td.style.verticalAlign = 'middle';
      return td;
    }

    async function loadData() {
      const params = new URLSearchParams();
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const sede = document.getElementById('sede').value;
      const tipo = document.getElementById('tipo').value;
      const status = document.getElementById('status').value;
      const profesional = document.getElementById('profesional').value;

      if (from) params.set('from', from);
      if (to) params.set('to', to);
      if (sede) params.set('sede', sede);
      if (tipo) params.set('tipo', tipo);
      if (status) params.set('status', status);
      if (profesional) params.set('profesional', profesional);

      // límite por seguridad (puedes subirlo)
      params.set('limit', '1000');

      const res = await fetch(`php/cita_table.php?${params.toString()}`, { cache: 'no-store' });
      const json = await res.json();
      if (!json.success) {
        alert(json.message || 'No se pudieron cargar las citas');
        return;
      }
      hot.loadData(json.data || []);
    }

    document.getElementById('btn-load').addEventListener('click', loadData);

    // Exportar CSV
    document.getElementById('btn-export').addEventListener('click', () => {
      const data = hot.getData();
      const headers = hot.getColHeader();
      const rows = [headers, ...data];
      const csv = rows.map(r => r.map(val => {
        const s = (val === null || val === undefined) ? '' : String(val);
        // escapar comillas y envolver si contiene coma / salto de línea
        const escaped = `"${s.replace(/"/g, '""')}"`;
        return escaped;
      }).join(',')).join('\r\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `citas-${ts}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    (function setDefaultDates(){
        const today = new Date();
        const fromDt = new Date(today); fromDt.setDate(today.getDate() - 15);
        const toDt   = new Date(today); toDt.setDate(today.getDate() + 15);
        const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        document.getElementById('from').value = fmt(fromDt);
        document.getElementById('to').value   = fmt(toDt);
    })();
    loadData();
  </script>
</body>
</html>
